\documentclass[10pt,a4paper]{cerndoc}

\CernDocSection{CERN BE-CO-HT}
\CernDocBorderColor{10,120,10}

\CernDocType{Functional Specifications}
\CernDocTitle{Gennum GN4124 Core For FMC Projects}
\CernDocEditedBy{Simon Deprez \\ Javier Serrano}
\CernDocCheckedBy{Javier Serrano}
\CernDocDate{June 2010}
\CernDocAbstract{This functional specification describes the HDL controller for Gennum GN4124 chip. This chip is used on the PCI express FMC carrier (\href{http://www.ohwr.org/projects/fmc-pci-carrier}{www.ohwr.org/projects/fmc-pci-carrier}). It provides a Wishbone master for control and status registers access and a DMA controller for high speed data transfers.}

\begin{document}
  \cerntitle
  \section*{Revision History}
  \begin{tabularx}{\textwidth}{|p{3cm}|p{3cm}|X|}
    \hline \textbf{Version}&\textbf{Date}&\textbf{Notes}\\ \hline \hline
    0.1 & 21-05-2010 & Initial release\\ \hline
    0.2 & 29-05-2010 & Add DMA master specifications\\ \hline
    0.3 & 01-06-2010 & Core diagram review + clocks\\ \hline

  \end{tabularx}

  \tableofcontents
  \listoffigures
  \clearpage

%  \section*{Introduction}
%  \addcontentsline{toc}{section}{Introduction}

  \section{Introduction}
The PCIe FMC carrier\footnote{See \href{http://www.ohwr.org/projects/fmc-pci-carrier}{www.ohwr.org/projects/fmc-pci-carrier}.} will be associated with several FMC\footnote{See VITA FMC standard: \href{http://www.vita.com/fmc}{www.vita.com/fmc}.} mezzanines. 

Each FMC mezzanine used with the PCIe FMC carrier will need a specific HDL configuration. The HDL code should be generic for reusing the carrier-specific modules with the other FMC mezzanines. 

 The communication between modules is essentially based on the Wishbone bus.




  \section{GN4124 core for PCIe FMC carrier}
  This core provides a Wishbone master to access control registers and read status.  The Wishbone\footnote{See \href{http://opencores.org/downloads/wbspec\_b3.pdf}{http://opencores.org/downloads/wbspec\_b3.pdf}.} bus is used for almost all communications between modules. The different soft cores are reusable.
  
  A simple DMA master is used for high speed data transfers of mezzanine card acquisitions.
  
\begin{figure}[!ht]
	\centering
		\includegraphics[width=13cm]{GN4124core}
	\caption{GN4124 core for PCIe FMC carrier}
	\label{fig:GCWWM}
\end{figure} 
    \subsection{GN4124 Local Bus Interface}
    
The GN4124 is a 4-lane PCI express to local bus bridge that is designed to work with a FPGA device to provide a high speed serial access for an application.
    
The GN412x PCI Express family Reference Manual\footnote{See \href{http://my.gennum.com/mygennum/view.php/gn4124-gullwing}{http://my.gennum.com/mygennum/view.php/gn4124-gullwing}.} (52624-0 June 2009) describes the local bus interface at page 40.

The data exchange is based on packets similar of PCI express packets, but the headers are different. It is not possible to send MSI (Message Signaled Interrupts) packets with this bus.
    
    \subsection{DMA Interface}
The DMA interface is a pipelined Wishbone bus. It performs application to host communications.

The DMA engine works with a linked list so that DMAs can be chained. The first item in the list is loaded by the host on the carrier and contains a pointer to the next one, which is in host memory. The DMA engine will fetch items from host memory and perform the corresponding DMAs until one of the items is recognized as the last one though the contents of the DMAATTRIBR register (see table~\ref{tab:ddr_control}). 

Each item in the list is made of the following registers: DMACSTARTR, DMAHSTARTLR, DMAHSTARTHR, DMALENR, DMANEXTLR, DMANEXTHR and DMAATTRIBR. When reading these items from the host, the DMA engine assumes a little-endian host. Big-endian hosts should shuffle data accordingly so that it is found in the same order as in a little-endian host. In addition, the DMA controller provides global DMA control and status registers.

The end of a chained DMA access generates an interrupt request towards the interrupt controller (\verb+DMA_IRQ_o+ output).  

\begin{table}[htbp]
  \centering
  \begin{tabularx}{\textwidth}{|l|r|l|l|X|}                                                     \hline
    \textbf{NAME}  & \textbf{OFFSET} & \textbf{MODE} & \textbf{RESET} & \textbf{DESCRIPTION}  \\ \hline \hline
    DMACTRLR       & & R/W & & DMA engine control                                             \\ \hline
    DMASTATR       & & RO  & & DMA engine status                                              \\ \hline
    DMACSTARTR     & & R/W & & DMA start address in the carrier                               \\ \hline
    DMAHSTARTLR    & & R/W & & DMA start address (low) in the host                            \\ \hline
    DMAHSTARTHR    & & R/W & & DMA start address (high) in the host                           \\ \hline
    DMALENR        & & R/W & & DMA read length in bytes                                       \\ \hline
    DMANEXTLR      & & R/W & & Pointer (low) to next item in list                             \\ \hline
    DMANEXTHR      & & R/W & & Pointer (high) to next item in list                            \\ \hline
    DMAATTRIBR     & & R/W & & DMA endianness and control                                     \\ \hline
  \end{tabularx}
  \caption{Register set for the DDR RAM controller block.}
  \label{tab:ddr_control}
\end{table}

\subsubsection{DMACTRLR}
Writing 1 to this register starts a DMA transfer. Writing 2 aborts the ongoing transfer.

\subsubsection{DMASTATR}
This is a status register for the DMA engine. Possible contents are:
\begin{packed_item}
\item 0: Idle (before any DMA transfer takes place).
\item 1: Done (after successful DMA).
\item 2: Busy.
\item 3: Error (following a memory access error, either on the host or on the carrier). This also produces an interrupt.
\item 4: Aborted (after receiving an abort command in DMACTRLR).
\end{packed_item}
A DMA start command written into the DMACTRLR register takes this status out of Idle, Done, Error or Aborted into the Busy state.

\subsubsection{DMACSTARTR}
The DMACSTARTR register holds a byte address pointing to a location inside the DDR RAM, at which the DMA access should start. Taking into account that the DDR is a 16-bit device, only even values are allowed in DMACSTARTR.

\subsubsection{DMAHSTARTLR and DMAHSTARTHR}
Registers DMAHSTARTLR and DMAHSTARTHR select the low and high parts of the 64-bit start address for the DMA access in the host. 

\subsubsection{DMALENR}
Register DMALENR selects the length of the reading in bytes, i.e. twice the number of samples to be read by the host. This means DMALENR has to hold an even number.

\subsubsection{DMANEXTLR and DMANEXTHR}
These two registers contain the low and high parts of the 64-bit address of the next item in the linked list, in host memory.

\subsubsection{DMAATTRIBR}
This register contains several control features for the DMA engine:
\begin{packed_item}
\item Bits [31..16] are reserved.
\item Bits [15..8] are used to select how many bytes the DDR controller jumps after every RAM access. A value of 2 will give interleaved samples. A value of 8 will give samples corresponding to a given channel.
\item Bits [7..2] are reserved.
\item Bit 1 is set to '0' for little-endian accesses and '1' for big-endian. This affects the way in which 16-bit samples can be stored in a 32-bit long word.
\item Bit 0 is set to '1' to signal this is the last item in the linked list, '0' otherwise.
\end{packed_item}

The end of a chained DMA access generates an interrupt request towards the interrupt controller.    
    \subsection{Wishbone interface}
    The Wishbone master transforms a PCIe write into a Wishbone write and a PCIe read into a Wishbone read.
    
    The communication speed on the Wishbone bus is controlled by the \verb+wb_clk_i+ input.
    
    \begin{tabularx}{\textwidth}{|X|cc|} \hline
      \multicolumn{3}{|c|}{WISHBONE DATASHEET for the 32-bit MASTER with 8-bit granularity}                    \\ \hline \hline
      \multicolumn{1}{|c|}{Description}  &\multicolumn{2}{c|} { Specification}                                 \\ \hline
      General description                &\multicolumn{2}{l|} { Wishbone master controlled by PCI express}     \\ \hline
      Supported cycles                   &\multicolumn{2}{l|} { MASTER, READ/WRITE }                           \\ \hline
      Data port, size:                   &\multicolumn{2}{l|} { 32-bit}                                        \\
      Data port, granularity:            &\multicolumn{2}{l|} { 8-bit}                                         \\
      Data port, maximum operand size    &\multicolumn{2}{l|} { 32-bit}                                        \\
      Clock frequency constraints:       &\multicolumn{2}{l|} { 100 MHz}                                       \\ \hline
      \multirow{8}{6cm}{Supported signal list and cross reference to equivalent WISHBONE signals}
      &  Signal Name       & WISHBONE Equiv.                                                                   \\
      &  wb\_clk\_i        &  CLK\_I                                                                           \\
      &  wb\_rst\_i        &  RST\_I                                                                           \\
      &  wb\_cyc\_o        &  CYC\_O                                                                           \\
      &  wb\_stb\_o        &  STB\_O                                                                           \\
      &  wb\_adr\_o(10..0) &  ADR\_O()                                                                         \\
      &  wb\_dat\_i(31..0) &  DAT\_I()                                                                         \\
      &  wb\_dat\_o(31..0) &  DAT\_O()                                                                         \\
      &  wb\_we\_o         &  WE\_O                                                                            \\
      &  wb\_ack\_i        &  ACK\_I                                                                           \\ \hline
	\end{tabularx}

   \subsection{Interrupts}
   When the GN4124 master get an one-tick-long positive pulse on the \verb+IRQ_req_i+ input, an appropriate signal is send on the \verb+IRQ_req_o+ output to the GN4124 chip. The interrupt signal is directly wired to GN4124 chip GPIO. When configured, the chip sends a MSI packet (Message Signaled Interrupts) to the host.
   
   At the end of a chained DMA acces, the DMA master send a one-tick-long (\verb+sys_clk+) interrupt signal on the \verb+DMA_IRQ_o+ output toward the interrupt controller.
   
   The \verb+sys_clk_i+ input is the reference for the interrupt pulses.
   

\end{document}







